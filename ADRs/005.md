# ADR.005 — Per-number ranking + two-stage (coarse→refine) no retrieval

## Context and Problem Statement

No RAG a unidade de resposta é a Súmula, não o chunk. Ranqueamentos só por chunk podem "diluir" o número correto. Precisamos de uma estratégia que pontue por número, com opção de dois estágios para acelerar/estabilizar.

## Decision Drivers

- Precisão na identificação da súmula final
- Latência controlada (especialmente com corpus crescendo)
- Simplicidade operacional e compatibilidade com FAISS Flat

## Considered Options

- Somente top-M chunks globais
- **Agregação per-number com pesos por seção** ✅
- **Two-stage (numbers centroid → chunks restritos)** ✅
- Vector DB já na v1

## Decision Outcome

- **Per-number obrigatório:** agregação por número com sum_sqrt (soma dos scores dividida por √n_chunks)
- **Pesos por seção:** enunciado/enunciado_mini > referências > excertos > orgão > header
- **Two-stage opcional:** numbers.faiss (centróides por súmula) → shortlist; refina em chunks.faiss

## Consequences

- Menos "competição interna" entre chunks da mesma súmula
- Estabilidade de ranking mesmo quando excertos são muito longos
- Two-stage reduz latência em N grande

## Risks & Mitigations

- **Risco:** Pesos ruins por seção podem enviesar  
  **Mitigação:** validar e ajustar em dev set
- **Risco:** Centróide ruim se os chunks forem heterogêneos  
  **Mitigação:** usar média robusta ou max por número e comparar
